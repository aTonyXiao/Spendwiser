<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/components/main/MainScreen.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav class="nav">
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="Account.html">Account</a></li></ul><h3>Modules</h3><ul><li><a href="module-AddCardDB.html">AddCardDB</a></li><li><a href="module-AddCardManual.html">AddCardManual</a></li><li><a href="module-AddCardModal.html">AddCardModal</a></li><li><a href="module-App.html">App</a></li><li><a href="module-BackButtonHeader.html">BackButtonHeader</a></li><li><a href="module-CameraSettingsBar.html">CameraSettingsBar</a></li><li><a href="module-Card.html">Card</a></li><li><a href="module-CardCarousel.html">CardCarousel</a></li><li><a href="module-CardImage.html">CardImage</a></li><li><a href="module-CardSelect.html">CardSelect</a></li><li><a href="module-CategoryModal.html">CategoryModal</a></li><li><a href="module-ChartBudget.html">ChartBudget</a><ul class='methods'><li data-type='method'><a href="module-ChartBudget.html#~Labels">Labels</a></li></ul></li><li><a href="module-ChartCompare.html">ChartCompare</a><ul class='methods'><li data-type='method'><a href="module-ChartCompare.html#~Labels">Labels</a></li></ul></li><li><a href="module-ChooseImage.html">ChooseImage</a></li><li><a href="module-DisplayCard.html">DisplayCard</a></li><li><a href="module-DoubleTap.html">DoubleTap</a></li><li><a href="module-EditImage.html">EditImage</a></li><li><a href="module-EditTransactionModal.html">EditTransactionModal</a></li><li><a href="module-Footer.html">Footer</a></li><li><a href="module-HeaderAndTabContent.html">HeaderAndTabContent</a></li><li><a href="module-HelpModal.html">HelpModal</a></li><li><a href="module-ListSummary.html">ListSummary</a></li><li><a href="module-LoadingScreen.html">LoadingScreen</a></li><li><a href="module-MainButtons.html">MainButtons</a></li><li><a href="module-MainHelp.html">MainHelp</a></li><li><a href="module-MainModals.html">MainModals</a></li><li><a href="module-MainScreen.html">MainScreen</a><ul class='methods'><li data-type='method'><a href="module-MainScreen.html#~addManualInput">addManualInput</a></li><li data-type='method'><a href="module-MainScreen.html#~backAction">backAction</a></li><li data-type='method'><a href="module-MainScreen.html#~getDisabledCards">getDisabledCards</a></li><li data-type='method'><a href="module-MainScreen.html#~getLocationFromAPI">getLocationFromAPI</a></li><li data-type='method'><a href="module-MainScreen.html#~onBottomSheetLayout">onBottomSheetLayout</a></li><li data-type='method'><a href="module-MainScreen.html#~reloadRecCard">reloadRecCard</a></li><li data-type='method'><a href="module-MainScreen.html#~setLocationDisabledMode">setLocationDisabledMode</a></li><li data-type='method'><a href="module-MainScreen.html#~setOfflineMode">setOfflineMode</a></li><li data-type='method'><a href="module-MainScreen.html#~switchStoresFromPOI">switchStoresFromPOI</a></li><li data-type='method'><a href="module-MainScreen.html#~tryToGetStoresFromLocation">tryToGetStoresFromLocation</a></li></ul></li><li><a href="module-ModalSlot.html">ModalSlot</a></li><li><a href="module-MoveableBlock.html">MoveableBlock</a></li><li><a href="module-PieChartSummary.html">PieChartSummary</a></li><li><a href="module-SpendingSummary.html">SpendingSummary</a><ul class='methods'><li data-type='method'><a href="module-SpendingSummary.html#~changeCategoriesLimit">changeCategoriesLimit</a></li><li data-type='method'><a href="module-SpendingSummary.html#~changeCategory">changeCategory</a></li><li data-type='method'><a href="module-SpendingSummary.html#~getCardFromDB">getCardFromDB</a></li><li data-type='method'><a href="module-SpendingSummary.html#~getCompareTimeFrameTransactions">getCompareTimeFrameTransactions</a></li><li data-type='method'><a href="module-SpendingSummary.html#~processTransaction">processTransaction</a></li><li data-type='method'><a href="module-SpendingSummary.html#~setCurCardFromModal">setCurCardFromModal</a></li><li data-type='method'><a href="module-SpendingSummary.html#~setNewPeriod">setNewPeriod</a></li></ul></li><li><a href="module-Textbox.html">Textbox</a></li><li><a href="module-TransactionModal.html">TransactionModal</a></li><li><a href="module-YourCards.html">YourCards</a></li></ul><h3>Classes</h3><ul><li><a href="AppleLogin.html">AppleLogin</a></li><li><a href="BaseBackend.html">BaseBackend</a><ul class='methods'><li data-type='method'><a href="BaseBackend.html#dbAdd">dbAdd</a></li><li data-type='method'><a href="BaseBackend.html#dbAddEncrypted">dbAddEncrypted</a></li><li data-type='method'><a href="BaseBackend.html#dbDelete">dbDelete</a></li><li data-type='method'><a href="BaseBackend.html#dbDoesDocExist">dbDoesDocExist</a></li><li data-type='method'><a href="BaseBackend.html#dbGet">dbGet</a></li><li data-type='method'><a href="BaseBackend.html#dbGetEncrypted">dbGetEncrypted</a></li><li data-type='method'><a href="BaseBackend.html#dbGetSubCollections">dbGetSubCollections</a></li><li data-type='method'><a href="BaseBackend.html#dbSet">dbSet</a></li><li data-type='method'><a href="BaseBackend.html#dbSetEncrypted">dbSetEncrypted</a></li><li data-type='method'><a href="BaseBackend.html#doesSupportDatabase">doesSupportDatabase</a></li><li data-type='method'><a href="BaseBackend.html#enableDatabaseCaching">enableDatabaseCaching</a></li><li data-type='method'><a href="BaseBackend.html#getLoginProviders">getLoginProviders</a></li><li data-type='method'><a href="BaseBackend.html#getTimestamp">getTimestamp</a></li><li data-type='method'><a href="BaseBackend.html#getUserID">getUserID</a></li><li data-type='method'><a href="BaseBackend.html#getUserInfo">getUserInfo</a></li><li data-type='method'><a href="BaseBackend.html#initializeApp">initializeApp</a></li><li data-type='method'><a href="BaseBackend.html#onAuthStateChange">onAuthStateChange</a></li><li data-type='method'><a href="BaseBackend.html#resetPassword">resetPassword</a></li><li data-type='method'><a href="BaseBackend.html#setPrivateKey">setPrivateKey</a></li><li data-type='method'><a href="BaseBackend.html#signIn">signIn</a></li><li data-type='method'><a href="BaseBackend.html#signInOffline">signInOffline</a></li><li data-type='method'><a href="BaseBackend.html#signOut">signOut</a></li><li data-type='method'><a href="BaseBackend.html#signUp">signUp</a></li><li data-type='method'><a href="BaseBackend.html#userAccountType">userAccountType</a></li><li data-type='method'><a href="BaseBackend.html#userLoggedIn">userLoggedIn</a></li></ul></li><li><a href="Cards.html">Cards</a><ul class='methods'><li data-type='method'><a href="Cards.html#addCardToDatabase">addCardToDatabase</a></li><li data-type='method'><a href="Cards.html#addJsonToDatabase">addJsonToDatabase</a></li><li data-type='method'><a href="Cards.html#getCardData">getCardData</a></li><li data-type='method'><a href="Cards.html#getCardImageURL">getCardImageURL</a></li><li data-type='method'><a href="Cards.html#getCardImg">getCardImg</a></li><li data-type='method'><a href="Cards.html#getCardName">getCardName</a></li><li data-type='method'><a href="Cards.html#getCardNames">getCardNames</a></li><li data-type='method'><a href="Cards.html#getCardReward">getCardReward</a></li></ul></li><li><a href="FacebookLogin.html">FacebookLogin</a></li><li><a href="FirebaseBackend.html">FirebaseBackend</a><ul class='methods'><li data-type='method'><a href="FirebaseBackend.html#dbAdd">dbAdd</a></li><li data-type='method'><a href="FirebaseBackend.html#dbDelete">dbDelete</a></li><li data-type='method'><a href="FirebaseBackend.html#dbDoesDocExist">dbDoesDocExist</a></li><li data-type='method'><a href="FirebaseBackend.html#dbGet">dbGet</a></li><li data-type='method'><a href="FirebaseBackend.html#dbGetSubCollections">dbGetSubCollections</a></li><li data-type='method'><a href="FirebaseBackend.html#dbGetSubCollectionsRemote">dbGetSubCollectionsRemote</a></li><li data-type='method'><a href="FirebaseBackend.html#dbSet">dbSet</a></li><li data-type='method'><a href="FirebaseBackend.html#doesSupportDatabase">doesSupportDatabase</a></li><li data-type='method'><a href="FirebaseBackend.html#enableDatabaseCaching">enableDatabaseCaching</a></li><li data-type='method'><a href="FirebaseBackend.html#getLoginProviders">getLoginProviders</a></li><li data-type='method'><a href="FirebaseBackend.html#getTimestamp">getTimestamp</a></li><li data-type='method'><a href="FirebaseBackend.html#getUserID">getUserID</a></li><li data-type='method'><a href="FirebaseBackend.html#getUserInfo">getUserInfo</a></li><li data-type='method'><a href="FirebaseBackend.html#initializeApp">initializeApp</a></li><li data-type='method'><a href="FirebaseBackend.html#onAuthStateChange">onAuthStateChange</a></li><li data-type='method'><a href="FirebaseBackend.html#remoteDBAdd">remoteDBAdd</a></li><li data-type='method'><a href="FirebaseBackend.html#remoteDBDelete">remoteDBDelete</a></li><li data-type='method'><a href="FirebaseBackend.html#remoteDBGet">remoteDBGet</a></li><li data-type='method'><a href="FirebaseBackend.html#remoteDBSet">remoteDBSet</a></li><li data-type='method'><a href="FirebaseBackend.html#resetPassword">resetPassword</a></li><li data-type='method'><a href="FirebaseBackend.html#signIn">signIn</a></li><li data-type='method'><a href="FirebaseBackend.html#signInOffline">signInOffline</a></li><li data-type='method'><a href="FirebaseBackend.html#signOut">signOut</a></li><li data-type='method'><a href="FirebaseBackend.html#signUp">signUp</a></li><li data-type='method'><a href="FirebaseBackend.html#userAccountType">userAccountType</a></li><li data-type='method'><a href="FirebaseBackend.html#userLoggedIn">userLoggedIn</a></li></ul></li><li><a href="GoogleLogin.html">GoogleLogin</a></li><li><a href="LoginAuthorizer.html">LoginAuthorizer</a><ul class='methods'><li data-type='method'><a href="LoginAuthorizer.html#login">login</a></li></ul></li><li><a href="RecommendCard.html">RecommendCard</a><ul class='methods'><li data-type='method'><a href="RecommendCard.html#getCategory">getCategory</a></li><li data-type='method'><a href="RecommendCard.html#getRecCards">getRecCards</a></li></ul></li><li><a href="ServerBackend.html">ServerBackend</a><ul class='methods'><li data-type='method'><a href="ServerBackend.html#dbAdd">dbAdd</a></li><li data-type='method'><a href="ServerBackend.html#dbDelete">dbDelete</a></li><li data-type='method'><a href="ServerBackend.html#dbDoesDocExist">dbDoesDocExist</a></li><li data-type='method'><a href="ServerBackend.html#dbGet">dbGet</a></li><li data-type='method'><a href="ServerBackend.html#dbGetSubCollections">dbGetSubCollections</a></li><li data-type='method'><a href="ServerBackend.html#dbGetSubCollectionsRemote">dbGetSubCollectionsRemote</a></li><li data-type='method'><a href="ServerBackend.html#dbSet">dbSet</a></li><li data-type='method'><a href="ServerBackend.html#doesSupportDatabase">doesSupportDatabase</a></li><li data-type='method'><a href="ServerBackend.html#enableDatabaseCaching">enableDatabaseCaching</a></li><li data-type='method'><a href="ServerBackend.html#getLoginProviders">getLoginProviders</a></li><li data-type='method'><a href="ServerBackend.html#getTimestamp">getTimestamp</a></li><li data-type='method'><a href="ServerBackend.html#getUserID">getUserID</a></li><li data-type='method'><a href="ServerBackend.html#getUserInfo">getUserInfo</a></li><li data-type='method'><a href="ServerBackend.html#getUserToken">getUserToken</a></li><li data-type='method'><a href="ServerBackend.html#initializeApp">initializeApp</a></li><li data-type='method'><a href="ServerBackend.html#onAuthStateChange">onAuthStateChange</a></li><li data-type='method'><a href="ServerBackend.html#remoteDBAdd">remoteDBAdd</a></li><li data-type='method'><a href="ServerBackend.html#remoteDBDelete">remoteDBDelete</a></li><li data-type='method'><a href="ServerBackend.html#remoteDBGet">remoteDBGet</a></li><li data-type='method'><a href="ServerBackend.html#remoteDBSet">remoteDBSet</a></li><li data-type='method'><a href="ServerBackend.html#resetPassword">resetPassword</a></li><li data-type='method'><a href="ServerBackend.html#signIn">signIn</a></li><li data-type='method'><a href="ServerBackend.html#signInOffline">signInOffline</a></li><li data-type='method'><a href="ServerBackend.html#signOut">signOut</a></li><li data-type='method'><a href="ServerBackend.html#signUp">signUp</a></li><li data-type='method'><a href="ServerBackend.html#userAccountType">userAccountType</a></li><li data-type='method'><a href="ServerBackend.html#userLoggedIn">userLoggedIn</a></li></ul></li><li><a href="SummaryHelper.html">SummaryHelper</a><ul class='methods'><li data-type='method'><a href="SummaryHelper.html#addSortedNewTransaction">addSortedNewTransaction</a></li><li data-type='method'><a href="SummaryHelper.html#getDbCards">getDbCards</a></li><li data-type='method'><a href="SummaryHelper.html#getTimeFrame">getTimeFrame</a></li><li data-type='method'><a href="SummaryHelper.html#matchTransactionToCategory">matchTransactionToCategory</a></li></ul></li><li><a href="userClass.html">userClass</a><ul class='methods'><li data-type='method'><a href="userClass.html#addTransactionId">addTransactionId</a></li><li data-type='method'><a href="userClass.html#addUser">addUser</a></li><li data-type='method'><a href="userClass.html#deleteCard">deleteCard</a></li><li data-type='method'><a href="userClass.html#deleteTransaction">deleteTransaction</a></li><li data-type='method'><a href="userClass.html#editTransaction">editTransaction</a></li><li data-type='method'><a href="userClass.html#getAllTransactions">getAllTransactions</a></li><li data-type='method'><a href="userClass.html#getCardDocId">getCardDocId</a></li><li data-type='method'><a href="userClass.html#getCards">getCards</a></li><li data-type='method'><a href="userClass.html#getMainNeedsUpdate">getMainNeedsUpdate</a></li><li data-type='method'><a href="userClass.html#getRewards">getRewards</a></li><li data-type='method'><a href="userClass.html#getTimeFrameTransactions">getTimeFrameTransactions</a></li><li data-type='method'><a href="userClass.html#getTransactionsForCard">getTransactionsForCard</a></li><li data-type='method'><a href="userClass.html#getUserId">getUserId</a></li><li data-type='method'><a href="userClass.html#saveCardToUser">saveCardToUser</a></li><li data-type='method'><a href="userClass.html#saveTransaction">saveTransaction</a></li><li data-type='method'><a href="userClass.html#setMainNeedsUpdate">setMainNeedsUpdate</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">src/components/main/MainScreen.js</h1>
    

    <!--container.tmpl-->




    <!--source.tmpl-->

    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import React, { useState, useEffect, useRef } from 'react';
import ReactNative, { View, Text, StyleSheet, Dimensions, Platform, BackHandler, SafeAreaView } from 'react-native';
import MapView, { Marker, PROVIDER_GOOGLE  } from 'react-native-maps';
import * as Location from 'expo-location';

import NetInfo from '@react-native-community/netinfo';
import { recommendCard } from './RecommendCard';
import { Footer } from '../util/Footer';
import { user } from '../../network/user';
import { useIsFocused } from '@react-navigation/native';
import { MainModals } from './MainModals';
import { CardCarousel } from './CardCarousel';
import BottomSheet from 'react-native-simple-bottom-sheet';
import { StatusBar } from 'expo-status-bar';
import { MainButtons } from './MainButtons';
import { useSafeAreaInsets } from 'react-native-safe-area-context';
import mainStyles from '../../styles/mainStyles';
import * as storage from '../../local/storage';

const googlePlaceSearchURL = "https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=";
const googlePlaceSearchRadius = "&amp;radius=100&amp;key=";
const googlePlaceDetailsURL = "https://maps.googleapis.com/maps/api/place/details/json?place_id=";
const googlePlaceDetailsFields = "&amp;fields=geometry,name,types,formatted_address,place_id&amp;key=";

/**
 * Display main screen with Google maps, nearby stores, and recommended cards based on selected stores
 * 
 * @param {Object} obj - Object passed to Main Screen
 * @param {Object} obj.navigation - navigation object used to move between different pages
 * @module MainScreen
 */
export function MainScreen({navigation}) {
    const [region, setRegion] = useState({
        latitude: 38.542530, 
        longitude: -121.749530,
        latitudeDelta: 0.0052,
        longitudeDelta: 0.0051,
    })
    const [isLoading, setLoading] = useState(true);
    const [storeArr, setStoreArr] = useState([]);
    const [curStore, setCurStore] = useState(null);
    const [curStoreKey, setCurStoreKey] = useState(null);
    const [modalVisible, setModalVisible] = useState(false);
    const [recCards, setRecCards] = useState(null);
    const isFocused = useIsFocused();
    const [locationInfoHeight, setLocationInfoHeight] = useState(0);
    const [footerHeight, setFooterHeight] = useState(0);
    const [userLocation, setUserLocation] = useState(null);
    const [internetState, setInternetState] = useState(false);
    const internetRef = useRef(false);

    /**
     * Set main screen to display no internet connection
     * Use case: No internet connection, have location permissions
     * @param {Array} coords - Coordinate array with user's location to set the current region to.
     * @function setOfflineMode
     */
    function setOfflineMode(coords) {
        // Only set storearr to show no internet connection when loading for the first time
        if (storeArr.length === 0) {
            setStoreArr([{
                label: "No Internet Connection",
                value: "No Internet Connection",
                vicinity: "Click help button for more info",
                placeId: "",
                geometry: [coords.latitude, coords.longitude],
                storeType: "N/A", 
                key: 0,
            }])
            setCurStore("No Internet Connection");
            setCurStoreKey(0);
            setRegion({...region, longitude: coords.longitude, latitude: coords.latitude});
            setRecCards(null);
            setLoading(false);
        }
    }

    /**
     * Set main screen to display no location permission
     * Use case: No location, with or without internet
     * @function setLocationDisabledMode
     */
    function setLocationDisabledMode() {
        setStoreArr([{
            label: "Location Permission Denied",
            value: "Location Permission Denied",
            vicinity: "Click help button for more info",
            placeId: "",
            geometry: [38.542530, -121.749530,],
            storeType: "N/A", 
            key: 0,
        }])
        setCurStore("Location Permission Denied");
        setCurStoreKey(0);
        setUserLocation({ latitude: 38.542530, longitude: -121.749530});
        setLoading(false);
    }

    /**
     * Prevent android users from using hardware back button on main screen
     * @returns {boolean} - Returns true on Main Screen and false on other pages
     * @function backAction
     */
    const backAction = () => {
        if (navigation.isFocused())
            return true;
        else
            return false;
    }

    /**
    * Calls storage function to check if card is disabled
    * @returns {array} - Is the card disabled or not
    * @function getDisabledCards
    */
     async function getDisabledCards() {
        return new Promise((resolve, reject) => {
            storage.getDisabledCards((val) => {
                let cardIdList = val['cards'];
                resolve(cardIdList);
            });
        })
    }

    /**
     * Sets the ranked cards and checks for disabled cards
     * @param {array} myRankedCards - the array of ranked cards objects
     * @callback getRecCardFromDB
     */
    function getRecCardFromDB(myRankedCards) {
        // check for disabled cards
        getDisabledCards().then((data) => {
            let disabledCards = data;
            let rankedEnabledCards = [];
            for (let i=0 ; i&lt; myRankedCards.length ; i++) {
                if (!(disabledCards.includes(myRankedCards[i].cardId))) {
                    rankedEnabledCards.push(myRankedCards[i]);
                }
            }
            setRecCards(rankedEnabledCards);
        })
    }

    /**
     * Called when recommended cards need changing
     * Should be called when user disable/enable cards, add cards, delete cards, change selected store
     * @param {string} value - new selected store
     * @param {int} key - index of new selected store in storeArr
     * @param {string} storeType - category of new selected store
     * @param {Array} geometry - Array with longitude and latitude of new selected store
     * @function reloadRecCard
     */
    function reloadRecCard(value, key, storeType, geometry) {
        recommendCard.getRecCards(storeType, getRecCardFromDB);
        if (key !== curStoreKey || curStore !== value) {
            setCurStore(value);
            setCurStoreKey(key);
            setRegion({...region, longitude: geometry[1], latitude: geometry[0]});
        }
    }

    /**
     * Function to switch selected store to user's selected store on Google Maps, then reload recommended cards
     * If new selected store not in storeArr, add the new store to the array.
     * @param {Object} event - POI object given by Google Maps on POI click
     * @function switchStoresFromPOI
     */
    function switchStoresFromPOI(event) {
        let last5placeId = event.placeId.substr(event.placeId.length - 5);
        let found = storeArr.find(o => (o.placeId.substr(o.placeId.length - 5) === last5placeId
            &amp;&amp; o.label.includes(event.name.slice(0, event.name.indexOf("\n")))));
        if (found === undefined) {
            NetInfo.fetch().then(state => {
                // If connected to internet, query API for nearby stores. Else: set offline mode
                if (state.isConnected) {
                    fetch(googlePlaceDetailsURL + 
                        event.placeId + 
                        googlePlaceDetailsFields + process.env.REACT_NATIVE_PLACE_SEARCH_API_KEY)
                    .then((response) => response.json())
                    .then((json) => {getLocationFromAPI(json)})
                    .catch((error) => console.log(error))
                }
            });
        } else {
            let index = storeArr.indexOf(found);
            reloadRecCard(storeArr[index].label, storeArr[index].key, storeArr[index].storeType, storeArr[index].geometry);
        }
    }

    /**
     * Add the manual store to the storeArr, set it as the selected store and reload the recommended cards
     * @param {Object} manualInputObj - object containing user's manual store to add to storeArr
     * @function addManualInput
     */
    function addManualInput(manualInputObj) {
        if (storeArr[0].value === 'Location Permission Denied' || storeArr[0].value === 'No Internet Connection') {
            if (manualInputObj.value === 'Manual Input 1') {
                manualInputObj.value = 'Manual Input 0';
                manualInputObj.label = 'Manual Input 0';
            }
            manualInputObj.key = 0;
            setStoreArr([manualInputObj]);
        }
        else
            setStoreArr(storeList => storeList.concat(manualInputObj));
        reloadRecCard(manualInputObj.label, manualInputObj.key, manualInputObj.storeType, manualInputObj.geometry);
    }

    /**
     * Load the store array with stores found 100m around the user's location
     * @param {JSON} json - JSON document with a list of stores
     * @function getLocationFromAPI
     */
    function getLocationFromAPI(json) {
        let fetchResult = json.results !== undefined ? json.results : [json.result];
        let fetchStores = [];
        if (fetchResult == undefined || fetchResult.length == 0) {
            return;
        }
        let addCount = storeArr.length - 1 === -1 ? 0 : storeArr.length;
        if (storeArr.length !== 0 &amp;&amp; (storeArr[0].value === 'Location Permission Denied' || storeArr[0].value === 'No Internet Connection'))
            addCount = 0;
        let fetchResultLen = Object.keys(fetchResult).length;

        for (let i = 0; i &lt; fetchResultLen; i++) {
            if (i === fetchResultLen) {
                break;
            }
            if (fetchResult[i].types.includes("locality")) {
                continue;
            } else if (storeArr.length === 0 || storeArr.find(o => o.placeId === JSON.stringify(fetchResult[i].place_id).slice(1,-1)) === undefined) {
                let storeType = JSON.stringify(fetchResult[i].types[0]).slice(1,-1).replace(/_/g, " ");
                storeType = storeType.charAt(0).toUpperCase() + storeType.slice(1);
                let address;
                if (json.results !== undefined) {
                    address = JSON.stringify(fetchResult[i].vicinity).slice(1,-1);
                } else {
                    address = JSON.stringify(fetchResult[i].formatted_address).slice(1,-1);
                    let commaIdx = address.indexOf(",");
                    commaIdx = address.indexOf(",", commaIdx + 1);
                    address = address.substr(0, commaIdx);
                }
                fetchStores.push({
                    label: JSON.stringify(fetchResult[i].name).slice(1,-1),
                    value: JSON.stringify(fetchResult[i].name).slice(1,-1),
                    vicinity: address,
                    placeId: JSON.stringify(fetchResult[i].place_id).slice(1,-1),
                    geometry: [parseFloat(JSON.stringify(fetchResult[i].geometry.location.lat)),
                        parseFloat(JSON.stringify(fetchResult[i].geometry.location.lng))],
                    storeType: storeType,
                    key: addCount,
                })
                addCount++;
            }
        }
        // Remove location permission denied info if clicking POI manually
        if (storeArr.length !== 0 &amp;&amp; (storeArr[0].value === 'Location Permission Denied' || storeArr[0].value === 'No Internet Connection')) {
            setStoreArr(fetchStores);
        }
        else
            setStoreArr(prevStores => [...prevStores, ...fetchStores]);
        if (fetchStores.length > 0) {
            setCurStore(fetchStores[0].label);
            setCurStoreKey(fetchStores[0].key);
            setRegion({...region, longitude: fetchStores[0].geometry[1], latitude: fetchStores[0].geometry[0]});
            recommendCard.getRecCards(fetchStores[0].storeType, getRecCardFromDB);
        }
    };

    /**
     * Check if app has location permission. If no permission, call setLocationDisabledMode()
     * Check if app has internet connection. If no internet, call setOfflineMode()
     * If have internet and location, fetch Google Places API and load stores into store array with getLocationFromAPI()
     * @async
     * @function tryToGetStoresFromLocation
     */
    async function tryToGetStoresFromLocation() {
        let { status } = await Location.requestForegroundPermissionsAsync();
        if (status !== 'granted') {
            setLocationDisabledMode();
        } else {
            try {
                let location = await Location.getCurrentPositionAsync({accuracy: Location.Accuracy.Balanced});
                setUserLocation(location.coords);
                NetInfo.fetch().then(state => {
                    // If connected to internet, query API for nearby stores. Else: set offline mode
                    if (state.isConnected) {
                        fetch(googlePlaceSearchURL + 
                            location.coords.latitude + "," + location.coords.longitude + 
                            googlePlaceSearchRadius + process.env.REACT_NATIVE_PLACE_SEARCH_API_KEY)
                        .then((response) => response.json())
                        .then((json) => {getLocationFromAPI(json)})
                        .catch((error) => console.log(error))
                        .finally(() => setLoading(false));
                    } else {
                        // Use case: Have location and no internet
                        setOfflineMode(location.coords);
                    }
                    });
            } catch(e) {
                setLocationDisabledMode();
                console.log("Error in getting location or stores");
            }
        } 
    }

    /**
     * Sets the minimum height of the bottom sheet by getting the height of the footer and the bottom sheet store text
     * @param {Object} event - object containing the height of the component the call came from
     * @param {int} insets - additional border height
     * @param {boolean} isFooter - if the function call came from the footer component
     * @function onBottomSheetLayout
     */
    function onBottomSheetLayout(event, insets, isFooter) {
        let {width, height} = event.nativeEvent.layout;
        if (!isFooter) {
            if (locationInfoHeight !== 0) {
                return;
            }
            setLocationInfoHeight(height + insets);
        } else {
            if (footerHeight !== 0) {
                return;
            }
            setFooterHeight(height + insets);
        }
    }

    /**
     * useEffect to be called when main screen in focus. Checks if recommended cards require update
     */
    useEffect(() => {
        user.currentStore = storeArr[curStoreKey];
        if (isLoading === false) {
            const unsubscribe = navigation.addListener('focus', () => {
                if (user.getMainNeedsUpdate()) {
                    /* triggered on a reload of the page */
                    reloadRecCard(curStore, curStoreKey, storeArr[curStoreKey].storeType, storeArr[curStoreKey].geometry);
                    user.setMainNeedsUpdate(false);
                }
            });
            return unsubscribe;
        }
    }, [isFocused]);

    /**
     * useEffect called on mount. Add android backpress and internet state event listener
     * call tryToGetStoresFromLocation() to setup main screen
     */
    useEffect(() => {
        BackHandler.addEventListener('hardwareBackPress', backAction);
        const unsubscribe = NetInfo.addEventListener(state => {
            if (internetRef.current === false &amp;&amp; state.isConnected === true) {
                if (storeArr.length > 0 &amp;&amp; storeArr[0].value === 'No Internet Connection') {
                    tryToGetStoresFromLocation();
                }
                internetRef.current = true;
                setInternetState(true);
            } else if (internetRef.current === true &amp;&amp; state.isConnected === false) {
                internetRef.current = false;
                setInternetState(false);
            }
        });
        (async () => {
            tryToGetStoresFromLocation();
        })();
        return () => {
            BackHandler.removeEventListener('hardwareBackPress', backAction);
            unsubscribe();
        }
    }, []);
    
    const insets = useSafeAreaInsets();

    return (
        &lt;View style={styles.screen} edges={["right", "bottom", "left"]}>
            &lt;StatusBar barStyle='dark-content'/>
            {/* Modal */}
            &lt;MainModals
                modalVisible={modalVisible}
                setModalVisible={setModalVisible}
                reloadRecCard={reloadRecCard}
                addManualInput={addManualInput}
                storeArr={storeArr}
                curStore={curStore}
                userLocation={userLocation}
            />
            &lt;View style={mainStyles.bodyContainer}>                
                {/* Map Area */}
                &lt;View style={mapStyles.mapContainer}>
                    {/* Butons */}
                    &lt;MainButtons
                        navigation={navigation}
                        setUserLocation={setUserLocation}
                        region={region}
                        setRegion={setRegion}
                        setModalVisible={setModalVisible}
                        internetState={internetState}
                        tryToGetStoresFromLocation= {tryToGetStoresFromLocation}
                    />

                    {/* Map (Google) */}
                    &lt;MapView 
                        style={mapStyles.map}
                        provider= {PROVIDER_GOOGLE}
                        region = {region}
                        onRegionChangeComplete = {(e)=> {
                            if (Math.abs(e.longitudeDelta - region.longitudeDelta) > 0.001)
                                setRegion(e);
                            }}
                        showsUserLocation={true}
                        onPoiClick={e => {if (internetState) switchStoresFromPOI(e.nativeEvent)}}
                        showsMyLocationButton={false}
                    >
                        {(storeArr.length > 0 &amp;&amp;
                            storeArr[0].value !== "No Internet Connection" &amp;&amp; storeArr[0].value !== "Location Permission Denied") &amp;&amp;
                            &lt;Marker coordinate={(curStoreKey !== null &amp;&amp; storeArr.length > 0 ?
                                { latitude: storeArr[curStoreKey].geometry[0], longitude: storeArr[curStoreKey].geometry[1]} :
                                { latitude: region.latitude, longitude: region.longitude }
                            )} />
                        }
                    &lt;/MapView>
                &lt;/View>
                &lt;View style={Platform.OS !== 'ios' ? {flex: 1} : {}}>
                    &lt;BottomSheet isOpen={false}
                        sliderMinHeight={Platform.OS === 'ios' ? locationInfoHeight + footerHeight + 75 : locationInfoHeight + footerHeight + 55}
                        sliderMaxHeight={(Dimensions.get('window').height)}
                        wrapperStyle={Platform.OS === 'ios' ? {paddingBottom: footerHeight + 25} : {paddingBottom: footerHeight + 25}}
                    >
                        {/* Location text */}
                        &lt;View style={mapStyles.textContainer} onLayout={(LayoutEvent) => onBottomSheetLayout(LayoutEvent, 0, false)}>
                            &lt;View style={mapStyles.locationTextContainer}>
                                &lt;Text
                                    style={{fontWeight: '500', fontSize: 20, textAlign: 'center', marginBottom: 10}}
                                    numberOfLines={1}
                                >{isLoading ? "Loading" : curStore}&lt;/Text>
                                &lt;Text>
                                    {isLoading || !(curStoreKey in storeArr) ? "N/A" : storeArr[curStoreKey].vicinity}
                                &lt;/Text>
                                &lt;Text>
                                    {(isLoading || curStore === 'Location Permission Denied' || curStore === 'No Internet Connection')
                                        ? " " : "Category: " + storeArr[curStoreKey].storeType}
                                &lt;/Text>
                            &lt;/View>
                        &lt;/View>

                        {/* Recommended Card */}
                        &lt;CardCarousel
                            recCards={recCards}
                            navigation={navigation}
                            storeArr={storeArr}
                            curStoreKey={curStoreKey}
                        />
                    &lt;/BottomSheet>
                &lt;/View>
            &lt;/View>
            {/* Footer */}
            &lt;View style={mainStyles.footerContainer} onLayout={(LayoutEvent => onBottomSheetLayout(LayoutEvent, insets.bottom, true))}>
                &lt;Footer navigation={navigation} />
            &lt;/View>
            &lt;View style={{alignSelf: "flex-end", width: "100%", height: insets.bottom, backgroundColor: "white"}} />
        &lt;/View>
        );
    }
    

const styles = StyleSheet.create({
    screen: {
        flex: 1,
        backgroundColor: 'white',
        height: '100%',
    },
    loc: {
        marginTop: 20,
        flex: 1,
        justifyContent: 'space-between',
    },
    loc_name: {
        fontSize: 20,
        fontWeight: 'bold',
    },
    footerContainer: {
        width: '100%',
        backgroundColor: 'white',
        position: 'absolute', 
        bottom: 0, 
        paddingBottom: 35,
        zIndex: 10,
    }
});

const mapStyles = StyleSheet.create({
    mapContainer: {
        alignItems: 'center',
    },
    map: {
        width: '100%',
        height: Dimensions.get('window').height,
    },
    textContainer : {
        alignItems: 'center',
        paddingBottom: 10,
    },
    locationTextContainer: {
        alignItems: 'center',
    }, 
    changeLocationButton: {
        alignItems: 'center',
        backgroundColor: '#28b573',
        margin: 15,
        borderRadius: 10,
        borderWidth: 1,
        borderColor: '#28b573',
        width: '40%',
        height: 40,
        justifyContent: 'center',
    },
    changeLocationButtonText : {
        color: 'white'
    }
});
</code></pre>
        </article>
    </section>





</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Thu Jun 03 2021 16:03:45 GMT-0700 (Pacific Daylight Time) using the LOKE theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
